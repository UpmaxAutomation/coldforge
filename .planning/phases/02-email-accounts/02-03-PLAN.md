# Plan 02-03: Microsoft 365 OAuth Connection

## Objective
Implement Microsoft OAuth flow for Outlook/Microsoft 365 account connection

## Context
- Users need to connect Outlook/M365 accounts via OAuth
- Requires Azure AD app registration (documented for user)
- Store OAuth tokens encrypted
- Use Microsoft Graph API for sending/receiving

## Tasks

<task type="auto">
  <name>Create Microsoft OAuth routes</name>
  <files>src/app/api/auth/microsoft/*.ts</files>
  <action>
    1. GET /api/auth/microsoft - Initiate OAuth flow
    2. GET /api/auth/microsoft/callback - Handle OAuth callback
    3. Store access_token, refresh_token encrypted
    4. Create email_account entry with provider='microsoft'
  </action>
  <verify>OAuth flow redirects correctly</verify>
  <done>Microsoft OAuth routes created</done>
</task>

<task type="auto">
  <name>Create Microsoft Graph utilities</name>
  <files>src/lib/microsoft.ts</files>
  <action>
    1. Create MSAL client initialization
    2. Token refresh logic
    3. Mail.Send and Mail.Read scopes
    4. Send email via Graph API function
    5. Fetch emails via Graph API function
  </action>
  <verify>TypeScript compiles</verify>
  <done>Microsoft utilities created</done>
</task>

<task type="auto">
  <name>Add Microsoft connection button</name>
  <files>src/components/email-accounts/microsoft-connect.tsx</files>
  <action>
    1. Create "Connect Microsoft Account" button
    2. Handle OAuth redirect
    3. Show connection status
    4. Add to accounts page
  </action>
  <verify>Button triggers OAuth flow</verify>
  <done>Microsoft connect button working</done>
</task>

## Success Criteria
- [ ] OAuth flow completes successfully
- [ ] Tokens stored encrypted
- [ ] Account appears in list after connection
