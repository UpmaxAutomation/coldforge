# Phase 17.5-18: Gap Fixes + Domain Auto-Purchase System

**Created**: 2026-01-30
**Goal**: Fix remaining gaps (95%→100%) + Complete Phase 14 (Domain Auto-Purchase)

---

## Part 1: Gap Fixes (Reply→Campaign + E2E Tests)

### 1.1 Reply→Campaign Link Verification & Fix

**Current State**: Code exists in `src/lib/inbox/sync.ts:586-719` but reportedly not working.

**Investigation Needed**:
1. Verify `X-Campaign-ID` and `X-Lead-ID` headers are set on outbound emails
2. Check if inbox sync cron is running and triggering `linkReplyToCampaign()`
3. Test the lookup logic with real data

**Files to check/modify**:
- `src/lib/queue/processors/campaign.ts` - outbound email headers
- `src/lib/sending/sender.ts` - SMTP headers
- `src/lib/inbox/sync.ts` - reply linking logic
- `src/app/api/cron/inbox-sync/route.ts` - cron trigger

**Tasks**:
- [ ] 1.1.1 Audit outbound email header injection (X-Campaign-ID, X-Lead-ID)
- [ ] 1.1.2 Verify headers are stored in `sent_emails` table
- [ ] 1.1.3 Test `linkReplyToCampaign()` with mock data
- [ ] 1.1.4 Fix any identified issues
- [ ] 1.1.5 Add logging for reply linking events

### 1.2 E2E Test Suite

**Current State**: `tests/integration/` is empty. Only unit tests exist.

**Test Categories**:
1. **Auth Flow** - signup, login, OAuth, session management
2. **Campaign Flow** - create, add leads, send, track events
3. **Inbox Flow** - sync, categorize, reply linking
4. **Domain Flow** - search, purchase, DNS setup, health check

**Files to create**:
```
tests/integration/
├── setup.ts              # Test DB, fixtures, helpers
├── auth.test.ts          # Auth flow E2E
├── campaigns.test.ts     # Campaign lifecycle E2E
├── inbox.test.ts         # Inbox sync + reply E2E
├── domains.test.ts       # Domain purchase E2E
└── fixtures/
    ├── users.ts
    ├── campaigns.ts
    └── emails.ts
```

**Tasks**:
- [ ] 1.2.1 Create E2E test setup (test DB, fixtures)
- [ ] 1.2.2 Write auth flow E2E tests
- [ ] 1.2.3 Write campaign flow E2E tests
- [ ] 1.2.4 Write inbox sync + reply linking E2E tests
- [ ] 1.2.5 Write domain purchase E2E tests

---

## Part 2: Phase 14 - Domain Auto-Purchase System

### 2.1 Wire Real Registrar Clients

**Current State**:
- `src/lib/domains/purchase.ts` has mock implementation
- `src/lib/registrars/cloudflare.ts` has real Cloudflare API client
- Need to connect them

**Tasks**:
- [ ] 2.1.1 Update `purchaseDomain()` to use real Cloudflare client
- [ ] 2.1.2 Add registrar credential management (env vars or encrypted storage)
- [ ] 2.1.3 Implement domain availability check via real API
- [ ] 2.1.4 Test with Cloudflare sandbox/test mode

### 2.2 Auto-DNS Setup After Purchase

**Current State**:
- SPF/DKIM/DMARC generators exist in `src/lib/dns/`
- Cloudflare DNS API wired in registrar client
- Need orchestration

**Flow**:
```
Domain Purchased
    ↓
Create DNS Zone (if not using registrar NS)
    ↓
Generate SPF Record → Add to DNS
    ↓
Generate DKIM Keys → Store encrypted → Add to DNS
    ↓
Generate DMARC Record → Add to DNS
    ↓
Verify propagation → Update health status
```

**Tasks**:
- [ ] 2.2.1 Create `setupDomainDns()` orchestration function
- [ ] 2.2.2 Auto-create SPF record after purchase
- [ ] 2.2.3 Auto-generate DKIM keys and add DNS record
- [ ] 2.2.4 Auto-create DMARC record
- [ ] 2.2.5 Add MX records for receiving (optional)
- [ ] 2.2.6 Implement DNS propagation checker
- [ ] 2.2.7 Update domain health status after verification

### 2.3 Stripe Integration for Domain Payments

**Current State**: Billing schema exists (migration 012), Stripe not wired for domains.

**Tasks**:
- [ ] 2.3.1 Create domain checkout session endpoint
- [ ] 2.3.2 Handle Stripe webhook for successful payment
- [ ] 2.3.3 Trigger domain purchase after payment confirmed
- [ ] 2.3.4 Store Stripe payment ID on domain record
- [ ] 2.3.5 Handle failed payments gracefully

### 2.4 Domain Dashboard UI Enhancements

**Current State**: Basic domain list exists. Need bulk search + health dashboard.

**Tasks**:
- [ ] 2.4.1 Build bulk domain search UI (search 10+ TLDs at once)
- [ ] 2.4.2 Add domain cart/checkout flow
- [ ] 2.4.3 Create domain health dashboard with scores
- [ ] 2.4.4 Add domain age warnings (< 30 days = risky)
- [ ] 2.4.5 Show DNS record status (SPF/DKIM/DMARC checkmarks)

---

## Execution Order

### Wave 1: Investigation & Quick Fixes (2-3 hours)
1. 1.1.1-1.1.3 - Audit reply linking
2. 1.1.4-1.1.5 - Fix issues found

### Wave 2: E2E Test Foundation (3-4 hours)
3. 1.2.1 - E2E setup
4. 1.2.2-1.2.3 - Auth + Campaign tests
5. 1.2.4-1.2.5 - Inbox + Domain tests

### Wave 3: Domain Purchase Wiring (3-4 hours)
6. 2.1.1-2.1.4 - Wire real registrar
7. 2.2.1-2.2.7 - Auto-DNS setup

### Wave 4: Stripe + UI (3-4 hours)
8. 2.3.1-2.3.5 - Stripe integration
9. 2.4.1-2.4.5 - UI enhancements

---

## Success Criteria

- [ ] Reply to campaign email → `campaign_leads.status` = 'replied' automatically
- [ ] E2E tests pass for auth, campaigns, inbox, domains
- [ ] Can search 10 domains, select, pay via Stripe, auto-DNS configured
- [ ] Domain health dashboard shows real-time SPF/DKIM/DMARC status
- [ ] Domain age warnings displayed for domains < 30 days old

---

## Files Modified/Created

**Part 1 (Gaps)**:
- `src/lib/inbox/sync.ts` - fix reply linking
- `src/lib/queue/processors/campaign.ts` - verify headers
- `tests/integration/*` - new E2E tests

**Part 2 (Phase 14)**:
- `src/lib/domains/purchase.ts` - wire to registrar
- `src/lib/domains/dns-setup.ts` - new orchestration
- `src/app/api/domains/checkout/route.ts` - new Stripe endpoint
- `src/app/api/webhooks/stripe/route.ts` - handle domain payment
- `src/app/(dashboard)/domains/*` - UI enhancements
